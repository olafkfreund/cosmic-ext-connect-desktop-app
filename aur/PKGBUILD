# Maintainer: Your Name <your.email@example.com>

pkgname=cosmic-ext-connect
pkgver=0.1.0
pkgrel=1
pkgdesc="Device connectivity for COSMIC Desktop"
arch=('x86_64')
url="https://github.com/olafkfreund/cosmic-ext-connect-desktop-app"
license=('GPL-3.0-or-later')
install=cosmic-ext-connect.install
depends=(
  'dbus'
  'gcc-libs'
  'glibc'
  'gstreamer'
  'gst-plugins-base'
  'gst-plugins-good'
  'gst-plugins-bad'
  'gtk3'
  'libpulse'
  'openssl'
  'pipewire'
  'wayland'
  'webkit2gtk-4.1'
)
makedepends=(
  'cargo'
  'git'
  'pkg-config'
  'rust'
)
optdepends=(
  'wireplumber: PipeWire session manager for RemoteDesktop plugin'
  'gst-plugins-ugly: Additional codec support for display streaming'
  'gst-libav: FFmpeg-based codec support'
)
provides=('cosmic-ext-connect')
conflicts=('cosmic-ext-connect-git')
source=(
  "$pkgname-$pkgver.tar.gz::$url/archive/v$pkgver.tar.gz"
  'cosmic-ext-connect-daemon.service'
)
sha256sums=(
  'SKIP'  # Update with actual checksum: updpkgsums
  'SKIP'
)

prepare() {
  cd "$pkgname-desktop-app-$pkgver"

  # Update Cargo.lock if needed
  cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
  cd "$pkgname-desktop-app-$pkgver"

  # Build with RemoteDesktop feature enabled
  export RUSTUP_TOOLCHAIN=stable
  export CARGO_TARGET_DIR=target

  cargo build \
    --frozen \
    --release \
    --workspace \
    --bins \
    --features cosmic-ext-connect-daemon/remotedesktop,cosmic-ext-connect-protocol/remotedesktop
}

check() {
  cd "$pkgname-desktop-app-$pkgver"

  # Skip tests that require DBus session
  # cargo test --frozen --workspace || true
}

package() {
  cd "$pkgname-desktop-app-$pkgver"

  # Install binaries
  install -Dm755 target/release/cosmic-ext-applet-connect -t "$pkgdir/usr/bin/"
  install -Dm755 target/release/cosmic-ext-connect-daemon -t "$pkgdir/usr/bin/"
  install -Dm755 target/release/cosmic-ext-connect-manager -t "$pkgdir/usr/bin/"
  install -Dm755 target/release/cosmic-ext-messages -t "$pkgdir/usr/bin/"
  install -Dm755 target/release/cosmic-ext-messages-popup -t "$pkgdir/usr/bin/"
  install -Dm755 target/release/cosmic-ext-connect-mirror -t "$pkgdir/usr/bin/"

  # Install systemd user service
  install -Dm644 "$srcdir/cosmic-ext-connect-daemon.service" \
    "$pkgdir/usr/lib/systemd/user/cosmic-ext-connect-daemon.service"

  # Install DBus service for activation
  install -Dm644 /dev/stdin "$pkgdir/usr/share/dbus-1/services/io.github.olafkfreund.CosmicExtConnect.service" <<EOF
[D-BUS Service]
Name=io.github.olafkfreund.CosmicExtConnect
Exec=/usr/bin/cosmic-ext-connect-daemon
SystemdService=cosmic-ext-connect-daemon.service
EOF

  install -Dm644 /dev/stdin "$pkgdir/usr/share/dbus-1/services/io.github.olafkfreund.CosmicExtMessagesPopup.service" <<EOF
[D-BUS Service]
Name=io.github.olafkfreund.CosmicExtMessagesPopup
Exec=/usr/bin/cosmic-ext-messages-popup --daemon
EOF

  # Install desktop entries
  install -Dm644 cosmic-ext-applet-connect/data/cosmic-ext-applet-connect.desktop \
    "$pkgdir/usr/share/applications/cosmic-ext-applet-connect.desktop"

  install -Dm644 cosmic-ext-messages-popup/data/io.github.olafkfreund.CosmicExtMessagesPopup.desktop \
    "$pkgdir/usr/share/applications/io.github.olafkfreund.CosmicExtMessagesPopup.desktop"

  # Install manager desktop entry
  install -Dm644 /dev/stdin "$pkgdir/usr/share/applications/cosmic-ext-connect-manager.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=COSMIC Connect Manager
Comment=Manage connected devices for COSMIC Desktop
GenericName=Device Manager
Keywords=Cosmic;Iced;connect;phone;device;sync;manager;
Icon=phone-symbolic
Exec=/usr/bin/cosmic-ext-connect-manager
Categories=Settings;HardwareSettings;
Terminal=false
StartupNotify=true
EOF

  # Install Flatpak desktop entries (for compatibility)
  install -Dm644 flatpak/io.github.olafkfreund.CosmicExtConnect.desktop \
    "$pkgdir/usr/share/applications/io.github.olafkfreund.CosmicExtConnect.desktop"

  install -Dm644 flatpak/io.github.olafkfreund.CosmicExtConnect.Applet.desktop \
    "$pkgdir/usr/share/applications/io.github.olafkfreund.CosmicExtConnect.Applet.desktop"

  # Install AppStream metadata
  install -Dm644 flatpak/io.github.olafkfreund.CosmicExtConnect.metainfo.xml \
    "$pkgdir/usr/share/metainfo/io.github.olafkfreund.CosmicExtConnect.metainfo.xml"

  # Install icons
  install -Dm644 connect_logo.png \
    "$pkgdir/usr/share/icons/hicolor/256x256/apps/io.github.olafkfreund.CosmicExtConnect.png"
  install -Dm644 data/icons/hicolor/scalable/apps/cosmic-ext-connect.svg \
    "$pkgdir/usr/share/icons/hicolor/scalable/apps/cosmic-ext-connect.svg"
  install -Dm644 data/icons/hicolor/symbolic/apps/cosmic-ext-connect-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/cosmic-ext-connect-symbolic.svg"
  install -Dm644 data/icons/hicolor/symbolic/apps/cosmic-ext-connect-phone-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/cosmic-ext-connect-phone-symbolic.svg"
  install -Dm644 data/icons/hicolor/symbolic/apps/cosmic-ext-connect-tablet-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/cosmic-ext-connect-tablet-symbolic.svg"
  install -Dm644 data/icons/hicolor/symbolic/apps/cosmic-ext-connect-laptop-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/cosmic-ext-connect-laptop-symbolic.svg"
  install -Dm644 data/icons/hicolor/symbolic/apps/cosmic-ext-connect-desktop-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/cosmic-ext-connect-desktop-symbolic.svg"
  install -Dm644 data/icons/hicolor/symbolic/apps/cosmic-ext-connect-tv-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/cosmic-ext-connect-tv-symbolic.svg"

  # Install documentation
  install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

# vim:set ts=2 sw=2 et:
